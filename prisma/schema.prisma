// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  moduleFormat    = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String
  role         String   @default("user")
  tokenVersion Int      @default(0)

  createdAt    DateTime @db.Timestamptz @default(now())
  updatedAt    DateTime @db.Timestamptz @updatedAt

  refreshTokens RefreshToken[]
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String

  revokedAt DateTime? @db.Timestamptz
  createdAt DateTime  @db.Timestamptz @default(now())
  expiresAt DateTime  @db.Timestamptz

  userAgent String?
  ip        String?

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
}

enum JobMasterState {
  PENDING
  PROCESSING
  CONSENSUS_REACHED
  DETAIL_FETCHED
  ERROR
  COMPLETE
}

enum IncrementalSyncHistoryState {
  PROCESSING
  ERROR
  COMPLETE
}

model JobMaster {
  id               BigInt         @id @default(autoincrement())
  appName          String         @db.VarChar(256) @default("default")
  jobDate          DateTime       @db.Date
  parameters       Json
  state            JobMasterState @default(PENDING)

  error            Json?

  consensusKey     String?
  consensusAt      DateTime? @db.Timestamptz
  
  detailFetchAt    DateTime? @db.Timestamptz

  finalizedAt      DateTime? @db.Timestamptz
  finalizeAttempts Int       @default(0)
  

  createdAt        DateTime  @db.Timestamptz @default(now())
  updatedAt        DateTime  @db.Timestamptz @updatedAt

  details          JobDetail[]
  orders           GineeOrderMaster[]
  orderItems       GineeOrderItem[]
  orderDetails     GineeOrderDetail[]

  @@unique([jobDate, appName])
  @@index([state])
}

model JobDetail {
  id              BigInt   @id @default(autoincrement())
  jobMasterId     BigInt

  executionStart  DateTime @db.Timestamptz @default(now())
  executionEnd    DateTime? @db.Timestamptz
  executionTimeMs Int?

  result          Json?
  error           Json?
  resultKey       String?

  createdAt       DateTime @db.Timestamptz @default(now())

  jobMaster       JobMaster @relation(fields: [jobMasterId], references: [id], onDelete: Cascade)

  @@index([jobMasterId])
  @@index([jobMasterId, resultKey])
}

model GineeOrderMaster {
  /// ===== Identity =====
  orderId String @id @db.VarChar(256)

  /// ===== Job trace (optional) =====
  jobMasterId BigInt?
  jobMaster   JobMaster? @relation(fields: [jobMasterId], references: [id], onDelete: Cascade)

  /// ===== Ownership / Channel =====
  country  String @db.Char(2)
  channel  String @db.VarChar(256)
  shopId   String @db.VarChar(256)

  /// ===== Order classification =====
  orderType     String? @db.VarChar(256)
  orderStatus   String  @db.VarChar(256)
  currency      String  @db.Char(3)

  /// ===== Amount =====
  totalAmount Decimal? @db.Decimal(18, 2)

  /// ===== Payment =====
  paymentMethod String? @db.VarChar(256)
  isCod         Boolean

  /// ===== External (Marketplace) =====
  externalShopId        String? @db.VarChar(256)
  externalOrderId       String? @db.VarChar(256)
  externalOrderSn       String? @db.VarChar(256)
  externalBookingSn     String? @db.VarChar(256)
  externalOrderStatus   String? @db.VarChar(256)
  externalCreateAt      DateTime? @db.Timestamptz
  externalUpdateAt      DateTime? @db.Timestamptz

  /// ===== Problem flags =====
  problemOrderTypes String[] @db.VarChar(256)

  /// ===== Important timestamps (UTC) =====
  createAt             DateTime @db.Timestamptz
  payAt                DateTime? @db.Timestamptz
  purchasedOn          DateTime? @db.Timestamptz
  closeAt              DateTime? @db.Timestamptz
  lastUpdateAt         DateTime @db.Timestamptz
  promisedToShipBefore DateTime? @db.Timestamptz
  totalQuantity        BigInt

  /// ===== Optional metadata =====
  customerName String? @db.VarChar(256)

  /// ===== Audit =====
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  details GineeOrderDetail[]
  items GineeOrderItem[]

  @@index([jobMasterId])
  @@index([shopId, createAt])
  @@index([channel, createAt])
  @@index([orderStatus])
  @@index([externalOrderSn])
  @@index([externalBookingSn])
  @@index([externalOrderId])
}

model GineeOrderDetail {
  /// ===== Identity =====
  id BigInt @id @default(autoincrement())

  /// ===== Parent order =====
  orderId String @db.VarChar(256)
  order   GineeOrderMaster @relation(fields: [orderId], references: [orderId], onDelete: Cascade)

  /// ===== Ingestion job (provenance) =====
  jobMasterId BigInt?
  jobMaster   JobMaster? @relation(fields: [jobMasterId], references: [id], onDelete: Cascade)

  invoiceInfo          Json? @db.JsonB
  shippingDocumentInfo Json? @db.JsonB
  shipInfo             Json? @db.JsonB
  printInfo            Json? @db.JsonB
  extraInfo            Json? @db.JsonB
  cancelInfo           Json? @db.JsonB
  logisticsInfos       Json? @db.JsonB
  shippingAddressInfo  Json? @db.JsonB
  paymentInfo          Json? @db.JsonB
  customerInfo         Json? @db.JsonB

  /// ===== Audit =====
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  @@index([orderId])
  @@index([jobMasterId])
}

model GineeOrderItem {
  /// ===== Identity =====
  itemId String @id @db.VarChar(256)

  /// ===== Parent order =====
  orderId String @db.VarChar(256)
  order   GineeOrderMaster @relation(fields: [orderId], references: [orderId], onDelete: Cascade)

  /// ===== Ingestion job (provenance) =====
  jobMasterId BigInt?
  jobMaster   JobMaster? @relation(fields: [jobMasterId], references: [id], onDelete: Cascade)

  /// ===== Product info =====
  productName     String? @db.VarChar(256)
  productImageUrl String? @db.VarChar(512)
  variationName   String? @db.VarChar(256)

  spu           String? @db.VarChar(256)
  sku           String? @db.VarChar(256)
  masterSku     String? @db.VarChar(256)
  masterSkuType String? @db.VarChar(256)

  /// ===== Quantity & pricing =====
  quantity           Int
  actualPrice        Decimal? @db.Decimal(18, 2)
  actualTotalPrice   Decimal? @db.Decimal(18, 2)
  originalPrice      Decimal? @db.Decimal(18, 2)
  originalTotalPrice Decimal? @db.Decimal(18, 2)
  discountedPrice    Decimal? @db.Decimal(18, 2)

  /// ===== External ids / status =====
  externalItemId          String? @db.VarChar(256)
  externalVariationId     String? @db.VarChar(256)
  externalProductId       String? @db.VarChar(256)
  externalOrderItemStatus String? @db.VarChar(256)

  /// ===== Flags =====
  isGift             Boolean?
  isFulfilByPlatform Boolean?

  /// ===== JSONB payloads =====
  bundleSkus           Json? @db.JsonB

  /// ===== Audit =====
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  @@index([orderId])
  @@index([jobMasterId])
  @@index([sku])
  @@index([masterSku])
  @@index([externalItemId])
}

model IncrementalSyncHistory {
  id            BigInt @id @default(autoincrement())
  appName       String @db.VarChar(256) @default("default")
  parameters    Json
  error         Json?
  consensusKey  String?
  createdAt     DateTime @default(now()) @db.Timestamptz
  updatedAt     DateTime @updatedAt @db.Timestamptz
  state         IncrementalSyncHistoryState @default(PROCESSING)
  result        Json?
  executionStart  DateTime @db.Timestamptz @default(now())
  executionEnd    DateTime? @db.Timestamptz
  executionTimeMs Int?
}
